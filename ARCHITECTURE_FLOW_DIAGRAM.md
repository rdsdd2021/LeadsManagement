# ğŸ—ï¸ Lead Management System - Architecture & Data Flow

## Table of Contents
1. [System Overview](#system-overview)
2. [Filter Flow](#filter-flow)
3. [Leads Data Flow](#leads-data-flow)
4. [Unique Values Flow](#unique-values-flow)
5. [Filter Counts Flow](#filter-counts-flow)
6. [Bulk Operations Flow](#bulk-operations-flow)
7. [CSV Import Flow](#csv-import-flow)
8. [Authentication Flow](#authentication-flow)
9. [Realtime Updates Flow](#realtime-updates-flow)
10. [Complete Interaction Map](#complete-interaction-map)

---

## 1. System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         FRONTEND (Next.js)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚   Pages      â”‚  â”‚  Components  â”‚  â”‚    Hooks     â”‚          â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚          â”‚
â”‚  â”‚ â€¢ Home       â”‚  â”‚ â€¢ FilterPanelâ”‚  â”‚ â€¢ useLeads   â”‚          â”‚
â”‚  â”‚ â€¢ Buckets    â”‚  â”‚ â€¢ LeadTable  â”‚  â”‚ â€¢ useFilters â”‚          â”‚
â”‚  â”‚ â€¢ Users      â”‚  â”‚ â€¢ BulkAssign â”‚  â”‚ â€¢ useBulk*   â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â”‚                 â”‚                  â”‚                   â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                           â”‚                                       â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                  â”‚  Zustand Store  â”‚                             â”‚
â”‚                  â”‚  (filterStore)  â”‚                             â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                           â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚         â”‚                 â”‚                 â”‚                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”              â”‚
â”‚    â”‚ API     â”‚      â”‚ Supabaseâ”‚      â”‚ Edge    â”‚              â”‚
â”‚    â”‚ Routes  â”‚      â”‚ Client  â”‚      â”‚ Functionsâ”‚              â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜              â”‚
â”‚         â”‚                 â”‚                 â”‚                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE BACKEND                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  PostgreSQL  â”‚  â”‚  Functions   â”‚  â”‚   Storage   â”‚ â”‚
â”‚  â”‚              â”‚  â”‚              â”‚  â”‚             â”‚ â”‚
â”‚  â”‚ â€¢ users      â”‚  â”‚ â€¢ get_filter â”‚  â”‚ â€¢ csv-      â”‚ â”‚
â”‚  â”‚ â€¢ leads      â”‚  â”‚   _counts()  â”‚  â”‚   imports   â”‚ â”‚
â”‚  â”‚ â€¢ buckets    â”‚  â”‚ â€¢ get_unique â”‚  â”‚             â”‚ â”‚
â”‚  â”‚ â€¢ custom_    â”‚  â”‚   _values()  â”‚  â”‚             â”‚ â”‚
â”‚  â”‚   fields     â”‚  â”‚ â€¢ is_admin() â”‚  â”‚             â”‚ â”‚
â”‚  â”‚ â€¢ import_    â”‚  â”‚ â€¢ is_admin_  â”‚  â”‚             â”‚ â”‚
â”‚  â”‚   jobs       â”‚  â”‚   or_mgr()   â”‚  â”‚             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              RLS Policies (Security)              â”‚ â”‚
â”‚  â”‚  â€¢ Admin/Manager: See all leads                   â”‚ â”‚
â”‚  â”‚  â€¢ Sales Rep: See only assigned leads             â”‚ â”‚
â”‚  â”‚  â€¢ Viewer: See only assigned leads                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 2. Filter Flow - How Filters Work

```
USER INTERACTION
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USER TYPES/SELECTS FILTER                                 â”‚
â”‚    Example: User selects "Male" in Gender filter             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. COMPONENT CALLS STORE ACTION                              â”‚
â”‚    FilterPanel.tsx                                            â”‚
â”‚    â”œâ”€ onChange={(value) => setGender(value)}                 â”‚
â”‚    â””â”€ Immediate UI update (checkbox checked)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ZUSTAND STORE UPDATES (filterStore.ts)                    â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚    â”‚ setGender: (gender) => {                             â”‚ â”‚
â”‚    â”‚   set({ gender, page: 0 })  â† Immediate state       â”‚ â”‚
â”‚    â”‚   clearTimeout(debounceTimer)                        â”‚ â”‚
â”‚    â”‚   debounceTimer = setTimeout(() => {                 â”‚ â”‚
â”‚    â”‚     applyDebouncedFilters()  â† After 800ms          â”‚ â”‚
â”‚    â”‚   }, 800)                                            â”‚ â”‚
â”‚    â”‚ }                                                     â”‚ â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚    State Structure:                                           â”‚
â”‚    â”œâ”€ gender: ['Male']           â† Immediate (UI)           â”‚
â”‚    â””â”€ debouncedGender: ['Male']  â† After 800ms (API)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼ (After 800ms debounce)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. REACT QUERY DETECTS CHANGE                                â”‚
â”‚    useLeads() hook watches debouncedGender                    â”‚
â”‚    â”œâ”€ queryKey changes                                        â”‚
â”‚    â””â”€ Triggers refetch                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. THREE PARALLEL API CALLS                                  â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚ GET LEADS      â”‚  â”‚ GET FILTER     â”‚  â”‚ GET UNIQUE   â”‚â”‚
â”‚    â”‚ /api/leads     â”‚  â”‚ COUNTS         â”‚  â”‚ VALUES       â”‚â”‚
â”‚    â”‚                â”‚  â”‚ /api/filter-   â”‚  â”‚ /api/unique- â”‚â”‚
â”‚    â”‚ Returns:       â”‚  â”‚ counts         â”‚  â”‚ values       â”‚â”‚
â”‚    â”‚ â€¢ 25 leads     â”‚  â”‚                â”‚  â”‚              â”‚â”‚
â”‚    â”‚ â€¢ Total count  â”‚  â”‚ Returns:       â”‚  â”‚ Returns:     â”‚â”‚
â”‚    â”‚                â”‚  â”‚ â€¢ School: {    â”‚  â”‚ â€¢ All schoolsâ”‚â”‚
â”‚    â”‚                â”‚  â”‚   "ABC": 50    â”‚  â”‚ â€¢ All        â”‚â”‚
â”‚    â”‚                â”‚  â”‚   "XYZ": 30    â”‚  â”‚   districts  â”‚â”‚
â”‚    â”‚                â”‚  â”‚ }              â”‚  â”‚ â€¢ All gendersâ”‚â”‚
â”‚    â”‚                â”‚  â”‚ â€¢ District: {} â”‚  â”‚ â€¢ All streamsâ”‚â”‚
â”‚    â”‚                â”‚  â”‚ â€¢ Gender: {}   â”‚  â”‚              â”‚â”‚
â”‚    â”‚                â”‚  â”‚ â€¢ Stream: {}   â”‚  â”‚              â”‚â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚             â”‚                   â”‚                  â”‚         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                   â”‚                  â”‚
              â–¼                   â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. COMPONENTS RE-RENDER WITH NEW DATA                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚    â”‚ LeadTable      â”‚  â”‚ FilterPanel    â”‚  â”‚ FilterPanel  â”‚â”‚
â”‚    â”‚ Shows filtered â”‚  â”‚ Shows counts   â”‚  â”‚ Shows        â”‚â”‚
â”‚    â”‚ leads          â”‚  â”‚ next to each   â”‚  â”‚ dropdown     â”‚â”‚
â”‚    â”‚                â”‚  â”‚ filter option  â”‚  â”‚ options      â”‚â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why Debouncing?

```
WITHOUT DEBOUNCE:
User types "John" â†’ 4 API calls (J, Jo, Joh, John)
âŒ Wastes resources
âŒ Slower performance
âŒ Database overload

WITH DEBOUNCE (800ms):
User types "John" â†’ Wait 800ms â†’ 1 API call (John)
âœ… Efficient
âœ… Fast
âœ… Database friendly
```


---

## 3. Leads Data Flow - How Leads are Fetched

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: User wants to see leads filtered by "Male" gender     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: HOOK INITIATES REQUEST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useLeads.ts                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const { debouncedGender } = useFilterStore()             â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ useQuery({                                               â”‚ â”‚
â”‚ â”‚   queryKey: ['leads', { gender: ['Male'], ... }]        â”‚ â”‚
â”‚ â”‚   queryFn: async () => {                                 â”‚ â”‚
â”‚ â”‚     const response = await fetch('/api/leads', {         â”‚ â”‚
â”‚ â”‚       method: 'POST',                                    â”‚ â”‚
â”‚ â”‚       body: JSON.stringify({ gender: ['Male'] })         â”‚ â”‚
â”‚ â”‚     })                                                    â”‚ â”‚
â”‚ â”‚   }                                                       â”‚ â”‚
â”‚ â”‚ })                                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 2: API ROUTE PROCESSES REQUEST
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app/api/leads/route.ts                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ export async function POST(request) {                    â”‚ â”‚
â”‚ â”‚   const { gender, school, district, ... } = await       â”‚ â”‚
â”‚ â”‚     request.json()                                       â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   // Build Supabase query                               â”‚ â”‚
â”‚ â”‚   let query = supabaseServer                            â”‚ â”‚
â”‚ â”‚     .from('leads')                                       â”‚ â”‚
â”‚ â”‚     .select('*, assigned_user:users!assigned_to(...)')  â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   // Apply filters                                       â”‚ â”‚
â”‚ â”‚   if (gender.length > 0) {                              â”‚ â”‚
â”‚ â”‚     query = query.in('gender', gender)                  â”‚ â”‚
â”‚ â”‚   }                                                       â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   // Execute with pagination                            â”‚ â”‚
â”‚ â”‚   const { data, count } = await query                   â”‚ â”‚
â”‚ â”‚     .range(start, end)                                   â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   return NextResponse.json({ data, count })             â”‚ â”‚
â”‚ â”‚ }                                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 3: SUPABASE EXECUTES QUERY
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL Database                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Generated SQL:                                           â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ SELECT                                                    â”‚ â”‚
â”‚ â”‚   leads.*,                                               â”‚ â”‚
â”‚ â”‚   users.id, users.email, users.name                      â”‚ â”‚
â”‚ â”‚ FROM leads                                               â”‚ â”‚
â”‚ â”‚ LEFT JOIN users ON leads.assigned_to = users.id         â”‚ â”‚
â”‚ â”‚ WHERE                                                     â”‚ â”‚
â”‚ â”‚   gender = ANY(ARRAY['Male'])                           â”‚ â”‚
â”‚ â”‚   AND (                                                   â”‚ â”‚
â”‚ â”‚     is_admin_or_manager()                               â”‚ â”‚
â”‚ â”‚     OR assigned_to = auth.uid()                         â”‚ â”‚
â”‚ â”‚   )  â† RLS Policy                                       â”‚ â”‚
â”‚ â”‚ ORDER BY created_at DESC                                 â”‚ â”‚
â”‚ â”‚ LIMIT 25 OFFSET 0                                        â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Uses Indexes:                                            â”‚ â”‚
â”‚ â”‚ â€¢ idx_leads_gender (fast gender filter)                 â”‚ â”‚
â”‚ â”‚ â€¢ idx_leads_created_at (fast sorting)                   â”‚ â”‚
â”‚ â”‚ â€¢ idx_users_role (fast RLS check)                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ Performance: ~50-200ms                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 4: DATA FLOWS BACK
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Response Structure:                                           â”‚
â”‚ {                                                             â”‚
â”‚   data: [                                                     â”‚
â”‚     {                                                         â”‚
â”‚       id: "uuid-1",                                          â”‚
â”‚       name: "John Doe",                                      â”‚
â”‚       phone: "1234567890",                                   â”‚
â”‚       school: "ABC School",                                  â”‚
â”‚       gender: "Male",                                        â”‚
â”‚       assigned_user: {                                       â”‚
â”‚         id: "user-uuid",                                     â”‚
â”‚         email: "sales@example.com",                          â”‚
â”‚         name: "Sales Rep"                                    â”‚
â”‚       },                                                      â”‚
â”‚       custom_fields: { ... }                                 â”‚
â”‚     },                                                        â”‚
â”‚     // ... 24 more leads                                     â”‚
â”‚   ],                                                          â”‚
â”‚   count: 2500  â† Total matching leads                        â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 5: REACT QUERY CACHES & PROVIDES DATA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ React Query Cache                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Key: ['leads', { gender: ['Male'], page: 0 }]           â”‚ â”‚
â”‚ â”‚ Data: { data: [...], count: 2500 }                      â”‚ â”‚
â”‚ â”‚ Cached for: 30 seconds                                   â”‚ â”‚
â”‚ â”‚ Status: 'success'                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 6: COMPONENT RENDERS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LeadTable Component                                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const { data, isLoading } = useLeads()                   â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ if (isLoading) return <Spinner />                        â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ return (                                                  â”‚ â”‚
â”‚ â”‚   <table>                                                 â”‚ â”‚
â”‚ â”‚     {data.data.map(lead => (                            â”‚ â”‚
â”‚ â”‚       <tr key={lead.id}>                                 â”‚ â”‚
â”‚ â”‚         <td>{lead.name}</td>                            â”‚ â”‚
â”‚ â”‚         <td>{lead.phone}</td>                           â”‚ â”‚
â”‚ â”‚         <td>{lead.school}</td>                          â”‚ â”‚
â”‚ â”‚         <td>{lead.gender}</td>                          â”‚ â”‚
â”‚ â”‚       </tr>                                              â”‚ â”‚
â”‚ â”‚     ))}                                                   â”‚ â”‚
â”‚ â”‚   </table>                                                â”‚ â”‚
â”‚ â”‚ )                                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 4. Unique Values Flow - Dropdown Options

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: FilterPanel needs to show all available schools       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: COMPONENT MOUNTS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FilterPanel.tsx                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const { data: uniqueValues } = useUniqueValues()         â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ <Select>                                                  â”‚ â”‚
â”‚ â”‚   {uniqueValues?.school.map(school => (                 â”‚ â”‚
â”‚ â”‚     <Option value={school}>{school}</Option>            â”‚ â”‚
â”‚ â”‚   ))}                                                     â”‚ â”‚
â”‚ â”‚ </Select>                                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 2: HOOK FETCHES DATA
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useUniqueValues.ts                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ useQuery({                                               â”‚ â”‚
â”‚ â”‚   queryKey: ['unique-values'],                          â”‚ â”‚
â”‚ â”‚   queryFn: async () => {                                 â”‚ â”‚
â”‚ â”‚     const response = await fetch('/api/unique-values')   â”‚ â”‚
â”‚ â”‚     return response.json()                               â”‚ â”‚
â”‚ â”‚   },                                                      â”‚ â”‚
â”‚ â”‚   staleTime: 60000  â† Cache for 60 seconds              â”‚ â”‚
â”‚ â”‚ })                                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 3: API ROUTE CALLS DATABASE FUNCTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app/api/unique-values/route.ts                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ export async function GET() {                            â”‚ â”‚
â”‚ â”‚   // Call database function (server-side aggregation)    â”‚ â”‚
â”‚ â”‚   const { data, error } = await supabaseServer          â”‚ â”‚
â”‚ â”‚     .rpc('get_unique_values')                           â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   return NextResponse.json(data)                         â”‚ â”‚
â”‚ â”‚ }                                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 4: DATABASE FUNCTION EXECUTES
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL Function: get_unique_values()                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ CREATE FUNCTION get_unique_values()                      â”‚ â”‚
â”‚ â”‚ RETURNS jsonb AS $$                                      â”‚ â”‚
â”‚ â”‚ DECLARE                                                   â”‚ â”‚
â”‚ â”‚   v_schools jsonb;                                       â”‚ â”‚
â”‚ â”‚   v_districts jsonb;                                     â”‚ â”‚
â”‚ â”‚   v_genders jsonb;                                       â”‚ â”‚
â”‚ â”‚   v_streams jsonb;                                       â”‚ â”‚
â”‚ â”‚ BEGIN                                                     â”‚ â”‚
â”‚ â”‚   -- Get unique schools                                  â”‚ â”‚
â”‚ â”‚   SELECT jsonb_agg(DISTINCT school ORDER BY school)     â”‚ â”‚
â”‚ â”‚   INTO v_schools                                         â”‚ â”‚
â”‚ â”‚   FROM leads                                             â”‚ â”‚
â”‚ â”‚   WHERE school IS NOT NULL AND school != '';            â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   -- Same for district, gender, stream...               â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   RETURN jsonb_build_object(                            â”‚ â”‚
â”‚ â”‚     'school', v_schools,                                 â”‚ â”‚
â”‚ â”‚     'district', v_districts,                             â”‚ â”‚
â”‚ â”‚     'gender', v_genders,                                 â”‚ â”‚
â”‚ â”‚     'stream', v_streams                                  â”‚ â”‚
â”‚ â”‚   );                                                      â”‚ â”‚
â”‚ â”‚ END;                                                      â”‚ â”‚
â”‚ â”‚ $$ LANGUAGE plpgsql SECURITY INVOKER;                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ Why SECURITY INVOKER?                                         â”‚
â”‚ â€¢ Respects RLS policies                                      â”‚
â”‚ â€¢ Admin sees all schools                                     â”‚
â”‚ â€¢ Sales rep sees only schools from assigned leads            â”‚
â”‚                                                               â”‚
â”‚ Performance: ~100-400ms (depends on data size)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 5: RESPONSE STRUCTURE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                                             â”‚
â”‚   school: [                                                   â”‚
â”‚     "ABC High School",                                       â”‚
â”‚     "XYZ Academy",                                           â”‚
â”‚     "Springfield School",                                    â”‚
â”‚     // ... 500 more schools                                  â”‚
â”‚   ],                                                          â”‚
â”‚   district: [                                                 â”‚
â”‚     "Central District",                                      â”‚
â”‚     "North District",                                        â”‚
â”‚     // ... 50 districts                                      â”‚
â”‚   ],                                                          â”‚
â”‚   gender: ["Male", "Female", "Other"],                       â”‚
â”‚   stream: ["Science", "Commerce", "Arts"]                    â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 6: DROPDOWN RENDERS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FilterPanel UI                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ School Filter:                                           â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚ â”‚ [Select School...]                            â–¼    â”‚  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚   â†“ (User clicks)                                       â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ ABC High School                                  â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ XYZ Academy                                      â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ Springfield School                               â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ ... (500 more options)                             â”‚  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 5. Filter Counts Flow - Faceted Search

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: Show how many leads match each filter option          â”‚
â”‚ Example: "Male (1,200)" "Female (1,300)"                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: HOOK WATCHES FOR FILTER CHANGES
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useFilterValueCounts.ts                                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const { debouncedSchool, debouncedDistrict, ... } =     â”‚ â”‚
â”‚ â”‚   useFilterStore()                                       â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ useQuery({                                               â”‚ â”‚
â”‚ â”‚   queryKey: ['filter-counts', {                         â”‚ â”‚
â”‚ â”‚     school, district, gender, stream                    â”‚ â”‚
â”‚ â”‚   }],                                                     â”‚ â”‚
â”‚ â”‚   queryFn: async () => {                                 â”‚ â”‚
â”‚ â”‚     const response = await fetch('/api/filter-counts', {â”‚ â”‚
â”‚ â”‚       method: 'POST',                                    â”‚ â”‚
â”‚ â”‚       body: JSON.stringify({ school, district, ... })   â”‚ â”‚
â”‚ â”‚     })                                                    â”‚ â”‚
â”‚ â”‚   }                                                       â”‚ â”‚
â”‚ â”‚ })                                                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 2: API ROUTE CALLS DATABASE FUNCTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ app/api/filter-counts/route.ts                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ export async function POST(request) {                    â”‚ â”‚
â”‚ â”‚   const filters = await request.json()                   â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   const { data } = await supabaseServer.rpc(            â”‚ â”‚
â”‚ â”‚     'get_filter_counts',                                â”‚ â”‚
â”‚ â”‚     {                                                     â”‚ â”‚
â”‚ â”‚       p_school: filters.school,                         â”‚ â”‚
â”‚ â”‚       p_district: filters.district,                     â”‚ â”‚
â”‚ â”‚       p_gender: filters.gender,                         â”‚ â”‚
â”‚ â”‚       p_stream: filters.stream,                         â”‚ â”‚
â”‚ â”‚       p_search_query: filters.searchQuery,              â”‚ â”‚
â”‚ â”‚       p_date_from: filters.dateRange.from,              â”‚ â”‚
â”‚ â”‚       p_date_to: filters.dateRange.to                   â”‚ â”‚
â”‚ â”‚     }                                                     â”‚ â”‚
â”‚ â”‚   )                                                       â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   return NextResponse.json(data)                         â”‚ â”‚
â”‚ â”‚ }                                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 3: DATABASE FUNCTION - FACETED SEARCH LOGIC
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PostgreSQL Function: get_filter_counts()                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Key Concept: EXCLUDE the field being counted            â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Example: Counting GENDER options                         â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚
â”‚ â”‚ â”‚ SELECT gender, COUNT(*) as count                     â”‚â”‚ â”‚
â”‚ â”‚ â”‚ FROM leads                                            â”‚â”‚ â”‚
â”‚ â”‚ â”‚ WHERE                                                 â”‚â”‚ â”‚
â”‚ â”‚ â”‚   -- Apply OTHER filters (NOT gender)                â”‚â”‚ â”‚
â”‚ â”‚ â”‚   school = ANY(p_school)      â† Applied             â”‚â”‚ â”‚
â”‚ â”‚ â”‚   AND district = ANY(p_district) â† Applied          â”‚â”‚ â”‚
â”‚ â”‚ â”‚   AND stream = ANY(p_stream)  â† Applied             â”‚â”‚ â”‚
â”‚ â”‚ â”‚   -- DON'T filter by gender! We're counting it      â”‚â”‚ â”‚
â”‚ â”‚ â”‚ GROUP BY gender                                       â”‚â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Why exclude the field being counted?                     â”‚ â”‚
â”‚ â”‚ â€¢ Shows "what if" scenarios                             â”‚ â”‚
â”‚ â”‚ â€¢ User can see impact of changing filter                â”‚ â”‚
â”‚ â”‚ â€¢ Enables faceted search UX                             â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Optimization:                                            â”‚ â”‚
â”‚ â”‚ â€¢ Uses indexes (idx_leads_gender, etc.)                 â”‚ â”‚
â”‚ â”‚ â€¢ Filters schools with <20 leads                        â”‚ â”‚
â”‚ â”‚ â€¢ Runs 5 queries in parallel (school, district, etc.)   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                               â”‚
â”‚ Performance: ~200-800ms (depends on filters)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 4: RESPONSE STRUCTURE
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ {                                                             â”‚
â”‚   school: {                                                   â”‚
â”‚     "ABC High School": 450,                                  â”‚
â”‚     "XYZ Academy": 320,                                      â”‚
â”‚     "Springfield School": 280,                               â”‚
â”‚     // Only schools with 20+ leads                           â”‚
â”‚   },                                                          â”‚
â”‚   district: {                                                 â”‚
â”‚     "Central District": 800,                                 â”‚
â”‚     "North District": 600,                                   â”‚
â”‚     "South District": 400                                    â”‚
â”‚   },                                                          â”‚
â”‚   gender: {                                                   â”‚
â”‚     "Male": 1200,                                            â”‚
â”‚     "Female": 1300                                           â”‚
â”‚   },                                                          â”‚
â”‚   stream: {                                                   â”‚
â”‚     "Science": 900,                                          â”‚
â”‚     "Commerce": 800,                                         â”‚
â”‚     "Arts": 800                                              â”‚
â”‚   },                                                          â”‚
â”‚   customFields: {                                             â”‚
â”‚     "grade": {                                               â”‚
â”‚       "10th": 500,                                           â”‚
â”‚       "11th": 600,                                           â”‚
â”‚       "12th": 1400                                           â”‚
â”‚     }                                                         â”‚
â”‚   }                                                           â”‚
â”‚ }                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
STEP 5: UI RENDERS WITH COUNTS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ FilterPanel UI                                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Gender Filter:                                           â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ Male (1,200)                                     â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ Female (1,300)                                   â”‚  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Stream Filter:                                           â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ Science (900)                                    â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ Commerce (800)                                   â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ â˜ Arts (800)                                       â”‚  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ User can see:                                            â”‚ â”‚
â”‚ â”‚ â€¢ How many leads match each option                       â”‚ â”‚
â”‚ â”‚ â€¢ Impact of selecting/deselecting filters                â”‚ â”‚
â”‚ â”‚ â€¢ Which options have no results (count = 0)              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 6. Bulk Operations Flow

### 6A. Bulk Assign Flow

```
USER ACTION: Assign 1000 leads to 3 sales reps
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USER OPENS BULK ASSIGN DIALOG                             â”‚
â”‚    â€¢ Selects users: [User A: 400, User B: 300, User C: 300] â”‚
â”‚    â€¢ Clicks "Assign"                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. useBulkAssign() HOOK                                       â”‚
â”‚    â”œâ”€ Gets current filters from filterStore                   â”‚
â”‚    â”œâ”€ Calls Edge Function (preferred) OR client-side         â”‚
â”‚    â””â”€ Shows progress dialog                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. EDGE FUNCTION: bulk-assign-leads                           â”‚
â”‚    supabase/functions/bulk-assign-leads/index.ts              â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 1. Authenticate user (check if admin/manager)        â”‚  â”‚
â”‚    â”‚ 2. Build query with filters                          â”‚  â”‚
â”‚    â”‚ 3. Fetch lead IDs (in batches of 1000)              â”‚  â”‚
â”‚    â”‚ 4. Distribute leads to users:                        â”‚  â”‚
â”‚    â”‚    â€¢ User A gets leads 0-399                         â”‚  â”‚
â”‚    â”‚    â€¢ User B gets leads 400-699                       â”‚  â”‚
â”‚    â”‚    â€¢ User C gets leads 700-999                       â”‚  â”‚
â”‚    â”‚ 5. Update in batches (100 at a time)                â”‚  â”‚
â”‚    â”‚ 6. Return total assigned count                       â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. DATABASE UPDATES                                           â”‚
â”‚    UPDATE leads                                               â”‚
â”‚    SET                                                        â”‚
â”‚      assigned_to = 'user-a-uuid',                            â”‚
â”‚      assignment_date = NOW(),                                â”‚
â”‚      updated_at = NOW()                                      â”‚
â”‚    WHERE id IN (lead-1, lead-2, ..., lead-400)              â”‚
â”‚                                                               â”‚
â”‚    (Repeat for User B and User C)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. REALTIME UPDATES                                           â”‚
â”‚    â€¢ Supabase broadcasts changes                             â”‚
â”‚    â€¢ All connected clients receive updates                   â”‚
â”‚    â€¢ React Query invalidates cache                           â”‚
â”‚    â€¢ UI refreshes automatically                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 6B. Bulk Delete Flow

```
USER ACTION: Delete 500 filtered leads
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. USER CLICKS "DELETE FILTERED LEADS"                       â”‚
â”‚    â€¢ Confirms deletion                                        â”‚
â”‚    â€¢ Shows progress                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. useBulkDelete() HOOK                                       â”‚
â”‚    â”œâ”€ Gets current filters                                    â”‚
â”‚    â”œâ”€ Calls Edge Function                                     â”‚
â”‚    â””â”€ Tracks progress                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. EDGE FUNCTION: bulk-delete-leads                           â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚    â”‚ 1. Authenticate (admin/manager only)                 â”‚  â”‚
â”‚    â”‚ 2. Build query with filters                          â”‚  â”‚
â”‚    â”‚ 3. Fetch lead IDs to delete                          â”‚  â”‚
â”‚    â”‚ 4. Delete in batches (100 at a time)                â”‚  â”‚
â”‚    â”‚ 5. Return deleted count                              â”‚  â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. DATABASE DELETES                                           â”‚
â”‚    DELETE FROM leads                                          â”‚
â”‚    WHERE id IN (lead-1, lead-2, ..., lead-100)              â”‚
â”‚                                                               â”‚
â”‚    (Repeat for remaining batches)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. CACHE INVALIDATION                                         â”‚
â”‚    â€¢ Invalidate leads query                                   â”‚
â”‚    â€¢ Invalidate filter counts                                 â”‚
â”‚    â€¢ Invalidate unique values                                 â”‚
â”‚    â€¢ UI refreshes with updated data                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 7. CSV Import Flow

```
USER ACTION: Import 5000 leads from CSV file
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 1: SELECT BUCKET                                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ User selects: "Seminar Leads" bucket                     â”‚ â”‚
â”‚ â”‚ â€¢ Loads custom fields for this bucket                    â”‚ â”‚
â”‚ â”‚ â€¢ Shows sample CSV download                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: UPLOAD & PARSE CSV                                    â”‚
â”‚ CSVUpload.tsx                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. User drops/selects CSV file                           â”‚ â”‚
â”‚ â”‚ 2. Parse CSV (handle quoted values, commas)             â”‚ â”‚
â”‚ â”‚ 3. Extract headers: [Name, Phone, School, Grade, ...]   â”‚ â”‚
â”‚ â”‚ 4. Show preview (first 5 rows)                           â”‚ â”‚
â”‚ â”‚ 5. Auto-map columns to fields                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: COLUMN MAPPING                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ CSV Column          â†’  Lead Field                        â”‚ â”‚
â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚
â”‚ â”‚ "Student Name"      â†’  Name *                            â”‚ â”‚
â”‚ â”‚ "Contact Number"    â†’  Phone Number *                    â”‚ â”‚
â”‚ â”‚ "School Name"       â†’  School *                          â”‚ â”‚
â”‚ â”‚ "Area"              â†’  District *                        â”‚ â”‚
â”‚ â”‚ "Gender"            â†’  Gender *                          â”‚ â”‚
â”‚ â”‚ "Course"            â†’  Stream *                          â”‚ â”‚
â”‚ â”‚ "Grade Level"       â†’  Grade (custom field)             â”‚ â”‚
â”‚ â”‚ "Parent Phone"      â†’  Parent Contact (custom field)    â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ * = Required fields                                      â”‚ â”‚
â”‚ â”‚ User can adjust mappings or skip columns                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: UPLOAD TO STORAGE                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const filePath = `${userId}/${timestamp}_leads.csv`     â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ await supabase.storage                                   â”‚ â”‚
â”‚ â”‚   .from('csv-imports')                                   â”‚ â”‚
â”‚ â”‚   .upload(filePath, file)                               â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Storage Structure:                                       â”‚ â”‚
â”‚ â”‚ csv-imports/                                             â”‚ â”‚
â”‚ â”‚   â””â”€ user-uuid-123/                                      â”‚ â”‚
â”‚ â”‚       â””â”€ 1699123456789_leads.csv                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: CREATE IMPORT JOB                                     â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ INSERT INTO import_jobs (                                â”‚ â”‚
â”‚ â”‚   user_id,                                               â”‚ â”‚
â”‚ â”‚   bucket_id,                                             â”‚ â”‚
â”‚ â”‚   file_path,                                             â”‚ â”‚
â”‚ â”‚   file_name,                                             â”‚ â”‚
â”‚ â”‚   status                                                 â”‚ â”‚
â”‚ â”‚ ) VALUES (                                               â”‚ â”‚
â”‚ â”‚   'user-uuid',                                           â”‚ â”‚
â”‚ â”‚   'bucket-uuid',                                         â”‚ â”‚
â”‚ â”‚   'user-uuid/1699123456789_leads.csv',                  â”‚ â”‚
â”‚ â”‚   'leads.csv',                                           â”‚ â”‚
â”‚ â”‚   'pending'                                              â”‚ â”‚
â”‚ â”‚ )                                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: TRIGGER EDGE FUNCTION                                 â”‚
â”‚ supabase/functions/import-csv-leads/index.ts                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ 1. Update job status to 'processing'                     â”‚ â”‚
â”‚ â”‚ 2. Download CSV from storage                             â”‚ â”‚
â”‚ â”‚ 3. Parse CSV (handle quotes, commas)                     â”‚ â”‚
â”‚ â”‚ 4. Get custom fields for bucket                          â”‚ â”‚
â”‚ â”‚ 5. Transform rows using column mappings:                 â”‚ â”‚
â”‚ â”‚    {                                                      â”‚ â”‚
â”‚ â”‚      name: row["Student Name"],                          â”‚ â”‚
â”‚ â”‚      phone: row["Contact Number"],                       â”‚ â”‚
â”‚ â”‚      school: row["School Name"],                         â”‚ â”‚
â”‚ â”‚      custom_fields: {                                    â”‚ â”‚
â”‚ â”‚        grade: row["Grade Level"],                        â”‚ â”‚
â”‚ â”‚        parent_contact: row["Parent Phone"]               â”‚ â”‚
â”‚ â”‚      }                                                    â”‚ â”‚
â”‚ â”‚    }                                                      â”‚ â”‚
â”‚ â”‚ 6. Insert in batches (100 at a time)                    â”‚ â”‚
â”‚ â”‚ 7. Update progress after each batch                      â”‚ â”‚
â”‚ â”‚ 8. Handle errors (log failed rows)                       â”‚ â”‚
â”‚ â”‚ 9. Mark job as 'completed'                              â”‚ â”‚
â”‚ â”‚ 10. Delete CSV file from storage                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 7: REALTIME PROGRESS UPDATES                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Frontend subscribes to import_jobs table:                â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ supabase                                                 â”‚ â”‚
â”‚ â”‚   .channel(`import-job-${jobId}`)                       â”‚ â”‚
â”‚ â”‚   .on('postgres_changes', {                             â”‚ â”‚
â”‚ â”‚     event: 'UPDATE',                                     â”‚ â”‚
â”‚ â”‚     table: 'import_jobs',                               â”‚ â”‚
â”‚ â”‚     filter: `id=eq.${jobId}`                            â”‚ â”‚
â”‚ â”‚   }, (payload) => {                                      â”‚ â”‚
â”‚ â”‚     setProgress(payload.new.processed_rows)             â”‚ â”‚
â”‚ â”‚   })                                                     â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ UI shows:                                                â”‚ â”‚
â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚ â”‚ â”‚ Processing leads...                                 â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 3,200 / 5,000          â”‚  â”‚ â”‚
â”‚ â”‚ â”‚ Success: 3,150  Failed: 50                         â”‚  â”‚ â”‚
â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 8: COMPLETION                                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ âœ… Import Complete!                                      â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Successfully Imported: 4,950                             â”‚ â”‚
â”‚ â”‚ Failed: 50                                               â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Errors:                                                  â”‚ â”‚
â”‚ â”‚ â€¢ Row 234: Missing required field 'phone'               â”‚ â”‚
â”‚ â”‚ â€¢ Row 567: Invalid email format                         â”‚ â”‚
â”‚ â”‚ â€¢ Row 890: Duplicate phone number                       â”‚ â”‚
â”‚ â”‚ ... (showing first 10 errors)                           â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ [Import Another File]                                    â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 8. Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: User logs in and accesses the system                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

STEP 1: LOGIN
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Login Page                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Email: admin@example.com                                 â”‚ â”‚
â”‚ â”‚ Password: â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢                                       â”‚ â”‚
â”‚ â”‚ [Login]                                                   â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ lib/auth.ts â†’ signIn()                                        â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const { data, error } = await supabase.auth             â”‚ â”‚
â”‚ â”‚   .signInWithPassword({ email, password })              â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ // Get user role from database                           â”‚ â”‚
â”‚ â”‚ const role = await getUserRole(data.user.id)            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 2: GET USER ROLE (with caching)                         â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ // Check cache first (1 min TTL)                         â”‚ â”‚
â”‚ â”‚ const cached = roleCache.get(userId)                     â”‚ â”‚
â”‚ â”‚ if (cached && !expired) return cached.role               â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ // Query database                                        â”‚ â”‚
â”‚ â”‚ SELECT role FROM users WHERE id = userId                 â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ // Cache result                                          â”‚ â”‚
â”‚ â”‚ roleCache.set(userId, { role, timestamp })              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 3: AUTH CONTEXT UPDATES                                  â”‚
â”‚ contexts/AuthContext.tsx                                      â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const [user, setUser] = useState<AuthUser | null>(null) â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ // On login success                                      â”‚ â”‚
â”‚ â”‚ setUser({                                                â”‚ â”‚
â”‚ â”‚   id: 'user-uuid',                                       â”‚ â”‚
â”‚ â”‚   email: 'admin@example.com',                           â”‚ â”‚
â”‚ â”‚   role: 'admin'                                          â”‚ â”‚
â”‚ â”‚ })                                                        â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ // Store session in localStorage                         â”‚ â”‚
â”‚ â”‚ // Supabase handles token refresh automatically          â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 4: REDIRECT TO HOME                                      â”‚
â”‚ router.push('/')                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 5: PAGE CHECKS AUTH                                      â”‚
â”‚ app/page.tsx                                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ const { user, loading } = useAuth()                      â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ useEffect(() => {                                        â”‚ â”‚
â”‚ â”‚   if (!loading && !user) {                              â”‚ â”‚
â”‚ â”‚     router.push('/login')  // Not authenticated         â”‚ â”‚
â”‚ â”‚   }                                                       â”‚ â”‚
â”‚ â”‚ }, [user, loading])                                      â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ if (loading) return <Spinner />                          â”‚ â”‚
â”‚ â”‚ if (!user) return null                                   â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ // User is authenticated, render page                    â”‚ â”‚
â”‚ â”‚ return <LeadsPage />                                     â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STEP 6: RLS POLICIES ENFORCE ACCESS                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Every database query checks:                             â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ SELECT * FROM leads                                      â”‚ â”‚
â”‚ â”‚ WHERE                                                     â”‚ â”‚
â”‚ â”‚   -- RLS Policy automatically added:                     â”‚ â”‚
â”‚ â”‚   (                                                       â”‚ â”‚
â”‚ â”‚     is_admin_or_manager()  â† Calls helper function     â”‚ â”‚
â”‚ â”‚     OR assigned_to = auth.uid()                         â”‚ â”‚
â”‚ â”‚   )                                                       â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Role-Based Access:                                       â”‚ â”‚
â”‚ â”‚ â€¢ Admin: Sees ALL leads                                  â”‚ â”‚
â”‚ â”‚ â€¢ Manager: Sees ALL leads                                â”‚ â”‚
â”‚ â”‚ â€¢ Sales Rep: Sees ONLY assigned leads                    â”‚ â”‚
â”‚ â”‚ â€¢ Viewer: Sees ONLY assigned leads                       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TOKEN REFRESH (Automatic)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Supabase Client (lib/supabase.ts)                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ createClient(url, key, {                                 â”‚ â”‚
â”‚ â”‚   auth: {                                                â”‚ â”‚
â”‚ â”‚     autoRefreshToken: true,  â† Enabled                  â”‚ â”‚
â”‚ â”‚     persistSession: true                                 â”‚ â”‚
â”‚ â”‚   }                                                       â”‚ â”‚
â”‚ â”‚ })                                                        â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚ Token expires after 1 hour                               â”‚ â”‚
â”‚ â”‚ Supabase automatically refreshes before expiry           â”‚ â”‚
â”‚ â”‚ AuthContext listens for TOKEN_REFRESHED event            â”‚ â”‚
â”‚ â”‚ No user action required                                  â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 9. Realtime Updates Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCENARIO: Admin assigns a lead, Sales Rep sees it instantly     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SETUP: REALTIME SUBSCRIPTION
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ hooks/useRealtime.ts                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ export function useRealtime({ table, queryKey }) {       â”‚ â”‚
â”‚ â”‚   const queryClient = useQueryClient()                   â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚   useEffect(() => {                                      â”‚ â”‚
â”‚ â”‚     const channel = supabase                            â”‚ â”‚
â”‚ â”‚       .channel(`realtime-${table}`)                     â”‚ â”‚
â”‚ â”‚       .on('postgres_changes', {                         â”‚ â”‚
â”‚ â”‚         event: '*',  // INSERT, UPDATE, DELETE          â”‚ â”‚
â”‚ â”‚         schema: 'public',                               â”‚ â”‚
â”‚ â”‚         table: table                                    â”‚ â”‚
â”‚ â”‚       }, (payload) => {                                  â”‚ â”‚
â”‚ â”‚         console.log('Realtime update:', payload)        â”‚ â”‚
â”‚ â”‚         queryClient.invalidateQueries(queryKey)         â”‚ â”‚
â”‚ â”‚       })                                                 â”‚ â”‚
â”‚ â”‚       .subscribe()                                       â”‚ â”‚
â”‚ â”‚                                                           â”‚ â”‚
â”‚ â”‚     return () => channel.unsubscribe()                  â”‚ â”‚
â”‚ â”‚   }, [])                                                 â”‚ â”‚
â”‚ â”‚ }                                                         â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

EVENT FLOW:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ADMIN ASSIGNS LEAD                                         â”‚
â”‚    UPDATE leads                                               â”‚
â”‚    SET assigned_to = 'sales-rep-uuid'                        â”‚
â”‚    WHERE id = 'lead-123'                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. POSTGRESQL TRIGGERS NOTIFICATION                           â”‚
â”‚    â€¢ Table has REPLICA IDENTITY FULL                          â”‚
â”‚    â€¢ Change is added to replication slot                      â”‚
â”‚    â€¢ Supabase Realtime server picks up change                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. SUPABASE BROADCASTS TO SUBSCRIBERS                         â”‚
â”‚    WebSocket message sent to all connected clients:           â”‚
â”‚    {                                                          â”‚
â”‚      event: 'UPDATE',                                         â”‚
â”‚      table: 'leads',                                          â”‚
â”‚      old: { assigned_to: null, ... },                        â”‚
â”‚      new: { assigned_to: 'sales-rep-uuid', ... }            â”‚
â”‚    }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. CLIENT RECEIVES UPDATE                                     â”‚
â”‚    useRealtime hook catches the event                         â”‚
â”‚    â”œâ”€ Logs: "Realtime update: UPDATE on leads"              â”‚
â”‚    â””â”€ Calls: queryClient.invalidateQueries(['leads'])        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. REACT QUERY REFETCHES DATA                                 â”‚
â”‚    â€¢ Marks cached data as stale                               â”‚
â”‚    â€¢ Triggers background refetch                              â”‚
â”‚    â€¢ Updates UI when new data arrives                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. UI UPDATES AUTOMATICALLY                                   â”‚
â”‚    Sales Rep's screen:                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚    â”‚ My Leads (25 â†’ 26)  â† Count updated                â”‚   â”‚
â”‚    â”‚                                                     â”‚   â”‚
â”‚    â”‚ [New lead appears at top of list]                  â”‚   â”‚
â”‚    â”‚ â€¢ John Doe                                          â”‚   â”‚
â”‚    â”‚   ABC School | Male | Science                      â”‚   â”‚
â”‚    â”‚   Assigned: Just now                                â”‚   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

MULTIPLE SUBSCRIPTIONS:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Each hook subscribes independently:                           â”‚
â”‚                                                               â”‚
â”‚ useLeads()           â†’ Subscribes to 'leads' table           â”‚
â”‚ useFilterValueCounts() â†’ Subscribes to 'leads' table         â”‚
â”‚ useUniqueValues()    â†’ Subscribes to 'leads' table           â”‚
â”‚                                                               â”‚
â”‚ When lead changes:                                            â”‚
â”‚ â”œâ”€ All three hooks receive notification                       â”‚
â”‚ â”œâ”€ All three invalidate their caches                          â”‚
â”‚ â””â”€ All three refetch their data                               â”‚
â”‚                                                               â”‚
â”‚ Result: Entire UI stays in sync automatically                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

PERFORMANCE OPTIMIZATION:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ Debounced refetches (prevent rapid updates)                â”‚
â”‚ â€¢ Stale-while-revalidate (show old data while fetching)      â”‚
â”‚ â€¢ Background refetch (no loading spinners)                    â”‚
â”‚ â€¢ Automatic retry on failure                                  â”‚
â”‚ â€¢ Connection recovery on disconnect                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## 10. Complete Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         COMPLETE SYSTEM INTERACTION MAP                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

FRONTEND LAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PAGES                    COMPONENTS                  HOOKS                   â”‚
â”‚ â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                  â”€â”€â”€â”€â”€                   â”‚
â”‚                                                                               â”‚
â”‚ app/page.tsx            FilterPanel.tsx             useLeads()              â”‚
â”‚   â”‚                       â”‚                           â”‚                      â”‚
â”‚   â”œâ”€ Renders table       â”œâ”€ School filter           â”œâ”€ Fetches leads       â”‚
â”‚   â”œâ”€ Pagination          â”œâ”€ District filter         â”œâ”€ Watches filters     â”‚
â”‚   â””â”€ Bulk actions        â”œâ”€ Gender filter           â””â”€ Caches results      â”‚
â”‚                          â”œâ”€ Stream filter                                    â”‚
â”‚ app/manage-buckets      â”œâ”€ Search box              useFilterValueCounts()  â”‚
â”‚   â”‚                      â””â”€ Date range               â”‚                      â”‚
â”‚   â”œâ”€ Bucket CRUD                                     â”œâ”€ Gets counts         â”‚
â”‚   â””â”€ Custom fields      LeadTable.tsx               â”œâ”€ Faceted search      â”‚
â”‚                          â”‚                           â””â”€ Shows badges        â”‚
â”‚ app/manage-users        â”œâ”€ Displays leads                                   â”‚
â”‚   â”‚                      â”œâ”€ Sorting                 useUniqueValues()       â”‚
â”‚   â””â”€ User management    â””â”€ Selection                â”‚                      â”‚
â”‚                                                       â”œâ”€ Dropdown options    â”‚
â”‚ app/login               BulkAssignDialog.tsx        â””â”€ All schools/etc     â”‚
â”‚   â”‚                      â”‚                                                   â”‚
â”‚   â””â”€ Authentication     â”œâ”€ User selection          useBulkAssign()         â”‚
â”‚                          â”œâ”€ Distribution            â”‚                      â”‚
â”‚                          â””â”€ Progress                â”œâ”€ Edge function       â”‚
â”‚                                                      â””â”€ Batch updates       â”‚
â”‚                         CSVUpload.tsx                                        â”‚
â”‚                          â”‚                          useBulkDelete()         â”‚
â”‚                          â”œâ”€ File upload             â”‚                      â”‚
â”‚                          â”œâ”€ Column mapping          â”œâ”€ Edge function       â”‚
â”‚                          â””â”€ Progress                â””â”€ Batch deletes       â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STATE MANAGEMENT (Zustand)                                                   â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                   â”‚
â”‚                                                                               â”‚
â”‚ filterStore.ts                                                               â”‚
â”‚ â”œâ”€ Immediate state (UI)          â† User types/selects                       â”‚
â”‚ â”‚  â€¢ school: ['ABC']                                                         â”‚
â”‚ â”‚  â€¢ gender: ['Male']                                                        â”‚
â”‚ â”‚  â€¢ searchQuery: 'John'                                                     â”‚
â”‚ â”‚                                                                             â”‚
â”‚ â”œâ”€ Debounced state (API)         â† After 800ms delay                        â”‚
â”‚ â”‚  â€¢ debouncedSchool: ['ABC']                                                â”‚
â”‚ â”‚  â€¢ debouncedGender: ['Male']                                               â”‚
â”‚ â”‚  â€¢ debouncedSearchQuery: 'John'                                            â”‚
â”‚ â”‚                                                                             â”‚
â”‚ â””â”€ Pagination                                                                â”‚
â”‚    â€¢ page: 0                                                                 â”‚
â”‚    â€¢ pageSize: 100                                                           â”‚
â”‚    â€¢ paginationMode: 'standard'                                              â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CACHING LAYER (React Query)                                                  â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                              â”‚
â”‚                                                                               â”‚
â”‚ Query Keys:                          Cache Duration:                         â”‚
â”‚ â”œâ”€ ['leads', {...filters}]          30 seconds                              â”‚
â”‚ â”œâ”€ ['filter-counts', {...filters}]  30 seconds                              â”‚
â”‚ â”œâ”€ ['unique-values']                 60 seconds                              â”‚
â”‚ â””â”€ ['import-job', jobId]             Realtime updates                        â”‚
â”‚                                                                               â”‚
â”‚ Features:                                                                     â”‚
â”‚ â”œâ”€ Automatic refetch on stale                                                â”‚
â”‚ â”œâ”€ Background updates                                                        â”‚
â”‚ â”œâ”€ Retry on failure                                                          â”‚
â”‚ â”œâ”€ Optimistic updates                                                        â”‚
â”‚ â””â”€ Realtime invalidation                                                     â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼

API LAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NEXT.JS API ROUTES                   EDGE FUNCTIONS                          â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                          â”‚
â”‚                                                                               â”‚
â”‚ /api/leads                           bulk-assign-leads                       â”‚
â”‚ â”œâ”€ POST: Get filtered leads          â”œâ”€ Authenticate                         â”‚
â”‚ â”œâ”€ Applies filters                   â”œâ”€ Build query                          â”‚
â”‚ â”œâ”€ Pagination                        â”œâ”€ Fetch IDs                            â”‚
â”‚ â””â”€ Joins with users                  â”œâ”€ Distribute                           â”‚
â”‚                                       â””â”€ Batch update                         â”‚
â”‚ /api/filter-counts                                                            â”‚
â”‚ â”œâ”€ POST: Get faceted counts          bulk-delete-leads                       â”‚
â”‚ â”œâ”€ Calls DB function                 â”œâ”€ Authenticate                         â”‚
â”‚ â””â”€ Returns JSONB                     â”œâ”€ Build query                          â”‚
â”‚                                       â”œâ”€ Fetch IDs                            â”‚
â”‚ /api/unique-values                   â””â”€ Batch delete                         â”‚
â”‚ â”œâ”€ GET: Get all options                                                      â”‚
â”‚ â”œâ”€ Calls DB function                 import-csv-leads                        â”‚
â”‚ â””â”€ Server-side aggregation           â”œâ”€ Download CSV                         â”‚
â”‚                                       â”œâ”€ Parse rows                           â”‚
â”‚ /api/admin/update-password           â”œâ”€ Transform data                       â”‚
â”‚ â””â”€ POST: Admin password reset        â”œâ”€ Batch insert                         â”‚
â”‚                                       â”œâ”€ Track progress                       â”‚
â”‚                                       â””â”€ Handle errors                        â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼

DATABASE LAYER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POSTGRESQL TABLES                    FUNCTIONS                               â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€                               â”‚
â”‚                                                                               â”‚
â”‚ users                                is_admin()                              â”‚
â”‚ â”œâ”€ id (UUID, PK)                     â””â”€ Returns: boolean                     â”‚
â”‚ â”œâ”€ email (TEXT)                      â””â”€ Used in: RLS policies               â”‚
â”‚ â”œâ”€ role (TEXT)                                                               â”‚
â”‚ â”œâ”€ name (TEXT)                       is_admin_or_manager()                   â”‚
â”‚ â””â”€ Indexes: role                     â””â”€ Returns: boolean                     â”‚
â”‚                                       â””â”€ Used in: RLS policies               â”‚
â”‚ leads                                                                         â”‚
â”‚ â”œâ”€ id (UUID, PK)                     current_user_role()                     â”‚
â”‚ â”œâ”€ name (TEXT)                       â””â”€ Returns: TEXT                        â”‚
â”‚ â”œâ”€ phone (TEXT)                      â””â”€ Used in: Application logic          â”‚
â”‚ â”œâ”€ school (TEXT)                                                             â”‚
â”‚ â”œâ”€ district (TEXT)                   get_filter_counts(...)                  â”‚
â”‚ â”œâ”€ gender (TEXT)                     â”œâ”€ Parameters: 8 filters                â”‚
â”‚ â”œâ”€ stream (TEXT)                     â”œâ”€ Returns: JSONB                       â”‚
â”‚ â”œâ”€ custom_fields (JSONB)             â”œâ”€ Logic: Faceted search               â”‚
â”‚ â”œâ”€ assigned_to (UUID, FK)            â””â”€ Performance: ~200-800ms             â”‚
â”‚ â”œâ”€ created_by (UUID, FK)                                                     â”‚
â”‚ â””â”€ Indexes: 11 indexes               get_unique_values()                     â”‚
â”‚    â€¢ school, district, etc.          â”œâ”€ Returns: JSONB                       â”‚
â”‚    â€¢ GIN on custom_fields            â”œâ”€ Logic: DISTINCT aggregation         â”‚
â”‚    â€¢ pg_trgm on name, phone          â””â”€ Performance: ~100-400ms             â”‚
â”‚                                                                               â”‚
â”‚ lead_buckets                         get_custom_field_unique_values(...)     â”‚
â”‚ â”œâ”€ id (UUID, PK)                     â”œâ”€ Parameter: field_name                â”‚
â”‚ â”œâ”€ name (TEXT, UNIQUE)               â”œâ”€ Returns: TABLE(value TEXT)          â”‚
â”‚ â”œâ”€ description (TEXT)                â””â”€ Logic: DISTINCT on JSONB field      â”‚
â”‚ â”œâ”€ is_active (BOOLEAN)                                                       â”‚
â”‚ â””â”€ color (TEXT)                      handle_new_user()                       â”‚
â”‚                                       â”œâ”€ Trigger: ON INSERT auth.users       â”‚
â”‚ custom_fields                        â””â”€ Logic: Auto-create profile          â”‚
â”‚ â”œâ”€ id (UUID, PK)                                                             â”‚
â”‚ â”œâ”€ bucket_id (UUID, FK)              update_updated_at_column()              â”‚
â”‚ â”œâ”€ name (TEXT)                       â”œâ”€ Trigger: ON UPDATE (all tables)     â”‚
â”‚ â”œâ”€ label (TEXT)                      â””â”€ Logic: Set updated_at = NOW()       â”‚
â”‚ â”œâ”€ field_type (TEXT)                                                         â”‚
â”‚ â””â”€ options (JSONB)                                                           â”‚
â”‚                                                                               â”‚
â”‚ import_jobs                                                                   â”‚
â”‚ â”œâ”€ id (UUID, PK)                                                             â”‚
â”‚ â”œâ”€ user_id (UUID, FK)                                                        â”‚
â”‚ â”œâ”€ status (TEXT)                                                             â”‚
â”‚ â”œâ”€ total_rows (INTEGER)                                                      â”‚
â”‚ â”œâ”€ success_count (INTEGER)                                                   â”‚
â”‚ â”œâ”€ failed_count (INTEGER)                                                    â”‚
â”‚ â””â”€ errors (JSONB)                                                            â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RLS POLICIES (Row Level Security)                                            â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                           â”‚
â”‚                                                                               â”‚
â”‚ leads table:                                                                  â”‚
â”‚ â”œâ”€ SELECT: is_admin_or_manager() OR assigned_to = auth.uid()                â”‚
â”‚ â”œâ”€ INSERT: is_admin_or_manager()                                             â”‚
â”‚ â”œâ”€ UPDATE: is_admin_or_manager() OR assigned_to = auth.uid()                â”‚
â”‚ â””â”€ DELETE: is_admin_or_manager()                                             â”‚
â”‚                                                                               â”‚
â”‚ users table:                                                                  â”‚
â”‚ â”œâ”€ SELECT: auth.uid() = id OR authenticated                                  â”‚
â”‚ â”œâ”€ UPDATE: auth.uid() = id                                                   â”‚
â”‚ â””â”€ INSERT: is_admin()                                                        â”‚
â”‚                                                                               â”‚
â”‚ lead_buckets table:                                                           â”‚
â”‚ â”œâ”€ SELECT: is_active = true                                                  â”‚
â”‚ â””â”€ ALL: is_admin()                                                           â”‚
â”‚                                                                               â”‚
â”‚ custom_fields table:                                                          â”‚
â”‚ â”œâ”€ SELECT: bucket is_active = true                                           â”‚
â”‚ â””â”€ ALL: is_admin()                                                           â”‚
â”‚                                                                               â”‚
â”‚ import_jobs table:                                                            â”‚
â”‚ â”œâ”€ SELECT: user_id = auth.uid() OR is_admin()                               â”‚
â”‚ â””â”€ INSERT: user_id = auth.uid()                                              â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                        â”‚
                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ STORAGE                              REALTIME                                 â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€                              â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚                                                                               â”‚
â”‚ csv-imports bucket                   Subscriptions:                           â”‚
â”‚ â”œâ”€ Structure:                        â”œâ”€ leads table                          â”‚
â”‚ â”‚  user-uuid/                        â”œâ”€ import_jobs table                    â”‚
â”‚ â”‚  â””â”€ timestamp_file.csv             â””â”€ Broadcasts: INSERT, UPDATE, DELETE  â”‚
â”‚ â”‚                                                                             â”‚
â”‚ â”œâ”€ RLS Policies:                     Features:                               â”‚
â”‚ â”‚  â€¢ INSERT: own folder              â”œâ”€ WebSocket connection                 â”‚
â”‚ â”‚  â€¢ SELECT: own folder              â”œâ”€ Automatic reconnect                  â”‚
â”‚ â”‚  â€¢ DELETE: own folder              â”œâ”€ Change data capture                  â”‚
â”‚ â”‚                                     â””â”€ Filtered subscriptions              â”‚
â”‚ â””â”€ Auto-cleanup after import                                                 â”‚
â”‚                                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## Summary: Key Architectural Decisions

### 1. **Debounced Filters (800ms)**
- **Why**: Prevents excessive API calls while user types
- **How**: Zustand store maintains both immediate and debounced state
- **Result**: 4 API calls â†’ 1 API call when typing "John"

### 2. **Server-Side Functions**
- **Why**: Bypass 1000-row limit, respect RLS, better performance
- **Functions**: `get_filter_counts()`, `get_unique_values()`, `get_custom_field_unique_values()`
- **Result**: Can aggregate millions of rows efficiently

### 3. **Optimized RLS Policies**
- **Why**: Inline subqueries were slow (1-2s per query)
- **How**: Helper functions `is_admin()`, `is_admin_or_manager()` with caching
- **Result**: 10-100x faster queries (~50-200ms)

### 4. **React Query Caching**
- **Why**: Reduce database load, improve UX
- **Strategy**: 30-60s cache + realtime invalidation
- **Result**: Instant UI updates, fewer database queries

### 5. **Faceted Search**
- **Why**: Show users what filters are available
- **How**: Count each field while excluding that field from filters
- **Result**: "Male (1,200)" "Female (1,300)" badges

### 6. **Edge Functions for Bulk Operations**
- **Why**: Client-side limited by browser, network, RLS
- **How**: Server-side processing with batching
- **Result**: Can process 10,000+ leads efficiently

### 7. **Realtime Updates**
- **Why**: Keep all users in sync
- **How**: PostgreSQL replication + WebSocket broadcasts
- **Result**: Instant updates across all connected clients

### 8. **Role-Based Access Control**
- **Why**: Security and data isolation
- **How**: RLS policies + helper functions
- **Result**: Admin sees all, Sales Rep sees only assigned

### 9. **CSV Import with Progress**
- **Why**: Handle large imports without blocking
- **How**: Edge function + realtime progress updates
- **Result**: Import 5,000 leads with live progress bar

### 10. **Performance Indexes**
- **Why**: Fast queries on large datasets
- **Indexes**: 11 indexes on leads table + pg_trgm for text search
- **Result**: Sub-second queries on millions of rows

---

## Performance Metrics

| Operation | Before Optimization | After Optimization |
|-----------|--------------------|--------------------|
| Page Load | 1.6s - 2s | <500ms |
| Filter Change | 1.2s - 1.5s | <200ms |
| Bulk Assign (1000) | 30s - 60s | 5s - 10s |
| CSV Import (5000) | N/A | 30s - 60s |
| Filter Counts | 2s - 5s | 200ms - 800ms |
| Unique Values | 1s - 2s | 100ms - 400ms |

---

## Data Flow Summary

```
USER ACTION
    â†“
COMPONENT (React)
    â†“
HOOK (React Query)
    â†“
STORE (Zustand) â† Debounce 800ms
    â†“
API ROUTE (Next.js) OR EDGE FUNCTION
    â†“
DATABASE FUNCTION (PostgreSQL)
    â†“
RLS POLICY CHECK (Security)
    â†“
INDEXES (Performance)
    â†“
RESULT
    â†“
CACHE (React Query)
    â†“
COMPONENT RE-RENDER
    â†“
USER SEES UPDATE

REALTIME (Parallel):
DATABASE CHANGE â†’ REPLICATION â†’ WEBSOCKET â†’ INVALIDATE CACHE â†’ REFETCH â†’ UPDATE UI
```

---

## File Structure Reference

```
Lead Management System
â”œâ”€â”€ Frontend
â”‚   â”œâ”€â”€ app/
â”‚   â”‚   â”œâ”€â”€ page.tsx (Main leads page)
â”‚   â”‚   â”œâ”€â”€ manage-buckets/page.tsx
â”‚   â”‚   â”œâ”€â”€ manage-users/page.tsx
â”‚   â”‚   â”œâ”€â”€ login/page.tsx
â”‚   â”‚   â””â”€â”€ api/
â”‚   â”‚       â”œâ”€â”€ leads/route.ts
â”‚   â”‚       â”œâ”€â”€ filter-counts/route.ts
â”‚   â”‚       â””â”€â”€ unique-values/route.ts
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ filters/FilterPanel.tsx
â”‚   â”‚   â”œâ”€â”€ leads/LeadTable.tsx
â”‚   â”‚   â”œâ”€â”€ leads/BulkAssignDialog.tsx
â”‚   â”‚   â””â”€â”€ csv-upload/CSVUpload.tsx
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useLeads.ts
â”‚   â”‚   â”œâ”€â”€ useFilterValueCounts.ts
â”‚   â”‚   â”œâ”€â”€ useUniqueValues.ts
â”‚   â”‚   â”œâ”€â”€ useBulkAssign.ts
â”‚   â”‚   â”œâ”€â”€ useBulkDelete.ts
â”‚   â”‚   â””â”€â”€ useRealtime.ts
â”‚   â”œâ”€â”€ stores/
â”‚   â”‚   â””â”€â”€ filterStore.ts (Zustand)
â”‚   â”œâ”€â”€ contexts/
â”‚   â”‚   â””â”€â”€ AuthContext.tsx
â”‚   â””â”€â”€ lib/
â”‚       â”œâ”€â”€ supabase.ts
â”‚       â””â”€â”€ auth.ts
â”œâ”€â”€ Backend (Supabase)
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 00000000000000_complete_optimized_schema.sql
â”‚   â””â”€â”€ functions/
â”‚       â”œâ”€â”€ bulk-assign-leads/
â”‚       â”œâ”€â”€ bulk-delete-leads/
â”‚       â””â”€â”€ import-csv-leads/
â””â”€â”€ Database
    â”œâ”€â”€ Tables: users, leads, lead_buckets, custom_fields, import_jobs
    â”œâ”€â”€ Functions: get_filter_counts, get_unique_values, is_admin, etc.
    â”œâ”€â”€ RLS Policies: Role-based access control
    â””â”€â”€ Indexes: 11 performance indexes
```

---

**End of Architecture Documentation**

This document provides a complete visual representation of how every component, hook, store, function, and database element works together in the Lead Management System.

